{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "EZGripper Configuration Schema",
  "description": "Configuration schema for EZGripper driver with Protocol 2.0 Dynamixel servos - Cleaned structure",
  "type": "object",
  "required": ["servo", "gripper", "communication"],
  "properties": {
    "servo": {
      "type": "object",
      "description": "Servo motor configuration",
      "required": ["dynamixel_settings", "force_management", "collision_detection"],
      "properties": {
        "dynamixel_settings": {
          "type": "object",
          "description": "Hardware settings applied to servo during initialization (used by ezgripper_base_clean.py)",
          "required": ["operating_mode", "current_limit"],
          "properties": {
            "operating_mode": {
              "type": "integer",
              "description": "Operating mode: 3=Position Control, 4=Extended Position Control, 5=Current-based Position Control",
              "enum": [3, 4, 5],
              "default": 5
            },
            "current_limit": {
              "type": "integer",
              "description": "Hardware current limit in units (1600 = 5376mA for MX-64)",
              "minimum": 0,
              "maximum": 2047,
              "default": 1600
            },
            "velocity_limit": {
              "type": "integer",
              "description": "Maximum velocity limit (0-1023 range)",
              "minimum": 0,
              "maximum": 1023,
              "default": 1023
            },
            "profile_velocity": {
              "type": "integer",
              "description": "Profile velocity for smooth movement",
              "minimum": 0,
              "maximum": 1023,
              "default": 500
            },
            "profile_acceleration": {
              "type": "integer",
              "description": "Profile acceleration for smooth movement",
              "minimum": 0,
              "maximum": 32767,
              "default": 800
            },
            "return_delay_time": {
              "type": "integer",
              "description": "Return delay time in microseconds",
              "minimum": 0,
              "maximum": 254,
              "default": 2
            },
            "status_return_level": {
              "type": "integer",
              "description": "Status return level: 0=never, 1=only READ, 2=always",
              "enum": [0, 1, 2],
              "default": 2
            }
          }
        },
        "force_management": {
          "type": "object",
          "description": "Force settings per GraspManager state (used by grasp_manager.py)",
          "required": ["moving_force_pct", "grasping_force_pct", "idle_force_pct"],
          "properties": {
            "moving_force_pct": {
              "type": "number",
              "description": "Force during MOVING state (closing/opening)",
              "minimum": 0,
              "maximum": 100,
              "default": 50
            },
            "grasping_force_pct": {
              "type": "number",
              "description": "Force during GRASPING state (holding after contact)",
              "minimum": 0,
              "maximum": 100,
              "default": 20
            },
            "idle_force_pct": {
              "type": "number",
              "description": "Force during IDLE state",
              "minimum": 0,
              "maximum": 100,
              "default": 10
            }
          }
        },
        "collision_detection": {
          "type": "object",
          "description": "Stall/contact detection settings (used by grasp_manager.py)",
          "required": ["consecutive_samples_required", "stall_tolerance_pct"],
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable collision detection",
              "default": true
            },
            "consecutive_samples_required": {
              "type": "integer",
              "description": "Number of consecutive stagnant readings to confirm contact",
              "minimum": 1,
              "maximum": 10,
              "default": 3
            },
            "stall_tolerance_pct": {
              "type": "number",
              "description": "Position range tolerance for stall detection (percentage)",
              "minimum": 0,
              "maximum": 100,
              "default": 2.0
            },
            "zero_target_tolerance_pct": {
              "type": "number",
              "description": "Tight tolerance for stable position at 0% target",
              "minimum": 0,
              "maximum": 100,
              "default": 0.04
            },
            "position_change_threshold_pct": {
              "type": "number",
              "description": "Threshold for state transitions",
              "minimum": 0,
              "maximum": 100,
              "default": 1.0
            },
            "command_change_threshold_pct": {
              "type": "number",
              "description": "Threshold for sending new servo commands",
              "minimum": 0,
              "maximum": 100,
              "default": 3.0
            }
          }
        }
      }
    },
    "gripper": {
      "type": "object",
      "description": "Gripper mechanical configuration",
      "required": ["grip_max", "position_scaling", "dex1_mapping"],
      "properties": {
        "grip_max": {
          "type": "integer",
          "description": "Maximum position range in servo units (0-2500 for practical range)",
          "minimum": 0,
          "maximum": 4095,
          "default": 2500
        },
        "position_scaling": {
          "type": "object",
          "description": "Position scaling configuration",
          "required": ["max_open_percent"],
          "properties": {
            "max_open_percent": {
              "type": "integer",
              "description": "Maximum open position percentage. 100% GUI command -> max_open_percent output",
              "minimum": 1,
              "maximum": 100,
              "default": 100
            }
          }
        },
        "dex1_mapping": {
          "type": "object",
          "description": "Mapping to Unitree Dex1 hand radians for DDS interface",
          "required": ["open_radians", "close_radians"],
          "properties": {
            "open_radians": {
              "type": "number",
              "description": "Dex1 hand radians for open position",
              "default": 5.4
            },
            "close_radians": {
              "type": "number",
              "description": "Dex1 hand radians for close position",
              "default": 0.0
            }
          }
        },
        "calibration": {
          "type": "object",
          "description": "Calibration sequence settings (used by ezgripper_dds_driver.py)",
          "properties": {
            "goto_position_target": {
              "type": "integer",
              "description": "Target position for calibration goto sequence",
              "default": -300
            },
            "goto_position_effort": {
              "type": "integer",
              "description": "Effort level for calibration",
              "minimum": 0,
              "maximum": 100,
              "default": 30
            },
            "settle_position": {
              "type": "integer",
              "description": "Position after calibration",
              "default": 35
            },
            "auto_on_init": {
              "type": "boolean",
              "description": "Automatically run calibration on driver initialization",
              "default": true
            }
          }
        }
      }
    },
    "communication": {
      "type": "object",
      "description": "Serial communication parameters (used by lib_robotis.py)",
      "required": ["device", "baudrate", "protocol_version", "servo_id"],
      "properties": {
        "device": {
          "type": "string",
          "description": "Serial device path for USB connection to Dynamixel servo",
          "default": "/dev/ttyUSB0"
        },
        "baudrate": {
          "type": "integer",
          "description": "Communication baudrate (1Mbps is standard for Dynamixel)",
          "enum": [57600, 115200, 1000000, 2000000, 3000000, 4000000],
          "default": 1000000
        },
        "protocol_version": {
          "type": "number",
          "description": "Dynamixel protocol version (2.0 for MX-64)",
          "enum": [1.0, 2.0],
          "default": 2.0
        },
        "servo_id": {
          "type": "integer",
          "description": "Dynamixel servo ID",
          "minimum": 0,
          "maximum": 252,
          "default": 1
        },
        "timeout": {
          "type": "number",
          "description": "Communication timeout (seconds)",
          "minimum": 0,
          "default": 0.5
        },
        "smart_init": {
          "type": "boolean",
          "description": "Enable smart initialization with automatic device detection",
          "default": true
        }
      }
    },
    "telemetry": {
      "type": "object",
      "description": "Telemetry publishing settings (used by ezgripper_dds_driver.py)",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable telemetry data publishing",
          "default": true
        },
        "topic_prefix": {
          "type": "string",
          "description": "DDS topic prefix for telemetry messages",
          "default": "rt/gripper"
        },
        "rate_hz": {
          "type": "integer",
          "description": "Telemetry publish rate in Hz",
          "minimum": 1,
          "maximum": 200,
          "default": 30
        },
        "qos_reliability": {
          "type": "string",
          "description": "DDS Quality of Service reliability",
          "enum": ["RELIABLE", "BEST_EFFORT"],
          "default": "RELIABLE"
        },
        "debug_enabled": {
          "type": "boolean",
          "description": "Enable debug telemetry",
          "default": false
        },
        "debug_topic_prefix": {
          "type": "string",
          "description": "DDS topic prefix for debug telemetry messages",
          "default": "rt/gripper/debug"
        }
      }
    },
    "logging": {
      "type": "object",
      "description": "Logging configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable system logging",
          "default": true
        },
        "level": {
          "type": "string",
          "description": "Logging level",
          "enum": ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"],
          "default": "INFO"
        },
        "log_errors": {
          "type": "boolean",
          "description": "Log error conditions",
          "default": true
        },
        "log_temperature": {
          "type": "boolean",
          "description": "Log temperature warnings",
          "default": true
        },
        "log_current": {
          "type": "boolean",
          "description": "Log current usage data",
          "default": false
        },
        "log_file": {
          "type": "string",
          "description": "System log file path",
          "default": "/var/log/ezgripper.log"
        },
        "max_log_size_mb": {
          "type": "integer",
          "description": "Maximum log file size before rotation",
          "minimum": 1,
          "default": 100
        }
      }
    }
  }
}

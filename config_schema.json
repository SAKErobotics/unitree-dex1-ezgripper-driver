{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "EZGripper Configuration Schema",
  "description": "Configuration schema for EZGripper driver with Protocol 2.0 Dynamixel servos",
  "type": "object",
  "required": ["servo", "gripper", "communication"],
  "properties": {
    "servo": {
      "type": "object",
      "description": "Servo motor configuration",
      "required": ["model", "operating_mode", "current_limits", "temperature", "registers"],
      "properties": {
        "model": {
          "type": "string",
          "description": "Servo model identifier",
          "enum": ["MX-64", "XM540"]
        },
        "operating_mode": {
          "type": "integer",
          "description": "Operating mode: 3=Position Control, 4=Extended Position Control (multi-turn), 16=PWM Control Mode",
          "enum": [3, 4, 16],
          "default": 4
        },
        "pwm_limit": {
          "type": "integer",
          "description": "PWM limit (maximum duty cycle, 0-885). Only used in PWM mode (16)",
          "minimum": 0,
          "maximum": 885,
          "default": 885
        },
        "current_limits": {
          "type": "object",
          "description": "Current limits in units (Protocol 2.0)",
          "required": ["holding", "movement", "max", "hardware_max"],
          "properties": {
            "holding": {
              "type": "integer",
              "description": "Holding current (13% of max, safe for continuous use)",
              "minimum": 0,
              "maximum": 2047
            },
            "movement": {
              "type": "integer",
              "description": "Movement current (30% of max, for active grasping)",
              "minimum": 0,
              "maximum": 2047
            },
            "max": {
              "type": "integer",
              "description": "Software-enforced maximum current (70% of hardware max)",
              "minimum": 0,
              "maximum": 2047
            },
            "hardware_max": {
              "type": "integer",
              "description": "Hardware maximum current capability",
              "minimum": 0,
              "maximum": 2047
            }
          }
        },
        "temperature": {
          "type": "object",
          "description": "Temperature thresholds in Celsius",
          "required": ["warning", "advisory", "shutdown", "hardware_max"],
          "properties": {
            "warning": {
              "type": "integer",
              "description": "Warning threshold - start monitoring closely",
              "minimum": 0,
              "maximum": 100
            },
            "advisory": {
              "type": "integer",
              "description": "Advisory threshold - approaching limit",
              "minimum": 0,
              "maximum": 100
            },
            "shutdown": {
              "type": "integer",
              "description": "Software shutdown threshold",
              "minimum": 0,
              "maximum": 100
            },
            "hardware_max": {
              "type": "integer",
              "description": "Hardware maximum temperature",
              "minimum": 0,
              "maximum": 100
            }
          }
        },
        "registers": {
          "type": "object",
          "description": "Dynamixel Protocol 2.0 register addresses",
          "required": ["operating_mode", "torque_enable", "current_limit", "goal_position", "present_position", "present_temperature", "present_current", "hardware_error"],
          "properties": {
            "operating_mode": {"type": "integer", "minimum": 0, "maximum": 255},
            "torque_enable": {"type": "integer", "minimum": 0, "maximum": 255},
            "current_limit": {"type": "integer", "minimum": 0, "maximum": 255},
            "goal_current": {"type": "integer", "minimum": 0, "maximum": 255},
            "pwm_limit": {"type": "integer", "minimum": 0, "maximum": 255},
            "goal_pwm": {"type": "integer", "minimum": 0, "maximum": 255},
            "present_pwm": {"type": "integer", "minimum": 0, "maximum": 255},
            "goal_position": {"type": "integer", "minimum": 0, "maximum": 255},
            "present_position": {"type": "integer", "minimum": 0, "maximum": 255},
            "present_temperature": {"type": "integer", "minimum": 0, "maximum": 255},
            "present_current": {"type": "integer", "minimum": 0, "maximum": 255},
            "present_voltage": {"type": "integer", "minimum": 0, "maximum": 255},
            "hardware_error": {"type": "integer", "minimum": 0, "maximum": 255},
            "homing_offset": {"type": "integer", "minimum": 0, "maximum": 255},
            "velocity_limit": {"type": "integer", "minimum": 0, "maximum": 255},
            "temperature_limit": {"type": "integer", "minimum": 0, "maximum": 255},
            "return_delay_time": {"type": "integer", "minimum": 0, "maximum": 255},
            "status_return_level": {"type": "integer", "minimum": 0, "maximum": 255}
          }
        },
        "eeprom_settings": {
          "type": "object",
          "description": "EEPROM optimization settings for best performance",
          "required": ["return_delay_time", "status_return_level"],
          "properties": {
            "return_delay_time": {
              "type": "integer",
              "description": "Return delay time (0 = immediate response, best performance)",
              "minimum": 0,
              "maximum": 254
            },
            "status_return_level": {
              "type": "integer",
              "description": "Status return level (0=none, 1=READ only, 2=all commands)",
              "minimum": 0,
              "maximum": 2
            }
          }
        },
        "backpressure_control": {
          "type": "object",
          "description": "Back-pressure detection and adaptive current control for gentle grasping",
          "required": ["enabled", "fast_current_level", "desired_force_level"],
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable back-pressure detection and adaptive current control",
              "default": true
            },
            "fast_current_level": {
              "type": "string",
              "description": "Current level to use for fast initial movement",
              "enum": ["holding", "movement", "max"],
              "default": "max"
            },
            "desired_force_level": {
              "type": "string", 
              "description": "Current level to use for desired force after contact",
              "enum": ["holding", "movement", "max"],
              "default": "movement"
            },
            "holding_current_level": {
              "type": "string",
              "description": "Current level to use for force maintenance",
              "enum": ["holding", "movement", "max"],
              "default": "holding"
            },
            "detection": {
              "type": "object",
              "description": "Back-pressure detection parameters",
              "required": ["current_spike_threshold", "stagnation_distance"],
              "properties": {
                "current_spike_threshold": {
                  "type": "integer",
                  "description": "Current threshold in mA for spike detection",
                  "minimum": 500,
                  "maximum": 2000,
                  "default": 1000
                },
                "stagnation_distance": {
                  "type": "integer",
                  "description": "Distance to target in raw units for stagnation detection",
                  "minimum": 10,
                  "maximum": 200,
                  "default": 50
                },
                "stagnation_movement": {
                  "type": "integer",
                  "description": "Minimum movement in raw units to consider 'moving'",
                  "minimum": 1,
                  "maximum": 10,
                  "default": 2
                },
                "monitor_frequency_hz": {
                  "type": "integer",
                  "description": "Monitoring frequency for back-pressure detection",
                  "minimum": 10,
                  "maximum": 200,
                  "default": 100
                },
                "detection_timeout_s": {
                  "type": "number",
                  "description": "Maximum time to wait for back-pressure detection",
                  "minimum": 1.0,
                  "maximum": 10.0,
                  "default": 5.0
                }
              }
            },
            "response": {
              "type": "object",
              "description": "Response parameters for back-pressure handling",
              "properties": {
                "reduction_delay_ms": {
                  "type": "integer",
                  "description": "Delay before reducing current (0 = immediate)",
                  "minimum": 0,
                  "maximum": 100,
                  "default": 0
                },
                "force_adjustment_step": {
                  "type": "integer",
                  "description": "Step size for fine force adjustments in mA",
                  "minimum": 1,
                  "maximum": 50,
                  "default": 10
                },
                "contact_settle_time_ms": {
                  "type": "integer",
                  "description": "Time to wait after contact detection before fine adjustments",
                  "minimum": 50,
                  "maximum": 500,
                  "default": 100
                }
              }
            }
          }
        }
      }
    },
    "gripper": {
      "type": "object",
      "description": "Gripper mechanical configuration",
      "required": ["grip_max", "position_scaling", "dex1_mapping"],
      "properties": {
        "grip_max": {
          "type": "integer",
          "description": "Maximum position range in servo units",
          "minimum": 0
        },
        "position_scaling": {
          "type": "object",
          "description": "Position scaling configuration",
          "required": ["max_open_percent"],
          "properties": {
            "max_open_percent": {
              "type": "integer",
              "description": "Maximum open position percentage. 0% is always fully closed. Commands are scaled: 100% input â†’ max_open_percent output",
              "minimum": 1,
              "maximum": 100,
              "default": 70
            }
          }
        },
        "dex1_mapping": {
          "type": "object",
          "description": "Mapping to Dex1 hand radians",
          "required": ["open_radians", "close_radians"],
          "properties": {
            "open_radians": {"type": "number"},
            "close_radians": {"type": "number"}
          }
        },
        "calibration": {
          "type": "object",
          "description": "Calibration parameters",
          "properties": {
            "current": {
              "type": "integer",
              "description": "Current to use during calibration",
              "minimum": 0
            },
            "position": {
              "type": "integer",
              "description": "Position to command for finding zero"
            },
            "timeout": {
              "type": "number",
              "description": "Timeout in seconds",
              "minimum": 0
            },
            "auto_on_init": {
              "type": "boolean",
              "description": "Auto-calibrate on initialization"
            }
          }
        }
      }
    },
    "wave_following": {
      "type": "object",
      "description": "Wave-following control algorithm parameters",
      "properties": {
        "enabled": {"type": "boolean"},
        "history_window": {
          "type": "integer",
          "description": "Number of commands to analyze",
          "minimum": 1
        },
        "variance_threshold": {
          "type": "number",
          "description": "Variance below this = steady state",
          "minimum": 0
        },
        "position_tolerance": {
          "type": "number",
          "description": "Position tolerance for 'at goal'",
          "minimum": 0
        },
        "mode_switch_delay": {
          "type": "number",
          "description": "Delay before switching modes (seconds)",
          "minimum": 0
        }
      }
    },
    "health_interface": {
      "type": "object",
      "description": "Health monitoring DDS interface",
      "properties": {
        "enabled": {"type": "boolean"},
        "topic": {"type": "string"},
        "rate_hz": {
          "type": "number",
          "description": "Publication rate in Hz",
          "minimum": 0
        },
        "qos_reliability": {
          "type": "string",
          "enum": ["RELIABLE", "BEST_EFFORT"]
        },
        "qos_durability": {
          "type": "string",
          "enum": ["VOLATILE", "TRANSIENT_LOCAL"]
        }
      }
    },
    "error_management": {
      "type": "object",
      "description": "Error detection and handling",
      "properties": {
        "auto_recovery": {"type": "boolean"},
        "max_attempts": {
          "type": "integer",
          "minimum": 0
        },
        "use_reboot": {"type": "boolean"},
        "retry_delay": {
          "type": "number",
          "minimum": 0
        }
      }
    },
    "communication": {
      "type": "object",
      "description": "Serial communication parameters",
      "required": ["device", "baudrate", "protocol_version", "servo_id"],
      "properties": {
        "device": {
          "type": "string",
          "description": "Serial device path"
        },
        "baudrate": {
          "type": "integer",
          "description": "Communication baudrate",
          "enum": [57600, 115200, 1000000, 2000000, 3000000, 4000000]
        },
        "protocol_version": {
          "type": "number",
          "description": "Dynamixel protocol version",
          "enum": [1.0, 2.0]
        },
        "servo_id": {
          "type": "integer",
          "description": "Servo ID",
          "minimum": 0,
          "maximum": 252
        },
        "timeout": {
          "type": "number",
          "description": "Communication timeout (seconds)",
          "minimum": 0
        },
        "smart_init": {
          "type": "boolean",
          "description": "Read servo values before writing to prevent EEPROM wear",
          "default": true
        }
      }
    },
    "logging": {
      "type": "object",
      "description": "Logging configuration",
      "properties": {
        "enabled": {"type": "boolean"},
        "level": {
          "type": "string",
          "enum": ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"]
        },
        "log_errors": {"type": "boolean"},
        "log_temperature": {"type": "boolean"},
        "log_current": {"type": "boolean"},
        "log_file": {"type": "string"},
        "max_log_size_mb": {
          "type": "integer",
          "minimum": 1
        }
      }
    }
  }
}
